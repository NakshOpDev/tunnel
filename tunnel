#!/bin/bash
# ======================================================================
# üöÄ Strelix Cloud Tunnel Manager v2
# Password-based Reverse SSH Tunnel Manager (autossh + sshpass)
# One-command tunnel setup with no SSH key required.
# Main Server: free-in1.halix.cloud
# ======================================================================

# --- CONFIGURATION ---
REMOTE_HOST="mc-usa1.halix-free.xyz"
REMOTE_USER="tunnel1"
REMOTE_PASS="naksh"
SSH_PORT="2912"

# --- COLORS & ICONS ---
C_RESET='\033[0m'
C_GREEN='\033[0;32m'
C_RED='\033[0;31m'
C_YELLOW='\033[0;33m'
C_CYAN='\033[0;36m'
C_WHITE='\033[1;37m'

OK="${C_GREEN}‚úÖ${C_RESET}"
ERR="${C_RED}‚ùå${C_RESET}"
INFO="${C_CYAN}‚ÑπÔ∏è${C_RESET}"
STOP="${C_YELLOW}üõë${C_RESET}"

usage() {
  echo -e "${C_WHITE}üöÄ Strelix Cloud Tunnel Manager${C_RESET}"
  echo -e "------------------------------------------------------------"
  echo -e "${C_CYAN}Usage:${C_RESET} $0 <command> [args]"
  echo -e "Commands:"
  echo -e "  ${C_YELLOW}make <LOCAL_PORT>${C_RESET}   - Create new tunnel (auto remote port)"
  echo -e "  ${C_YELLOW}list${C_RESET}              - Show active tunnels"
  echo -e "  ${C_YELLOW}kill <PID>${C_RESET}        - Stop tunnel by PID"
  echo -e "  ${C_YELLOW}killall${C_RESET}           - Kill all tunnels"
  echo -e "  ${C_YELLOW}setup-server${C_RESET}      - Setup tunnel server (run on ${REMOTE_HOST})"
  echo -e "------------------------------------------------------------"
}

# --- Ensure dependencies ---
ensure_tools() {
  if ! command -v autossh >/dev/null || ! command -v sshpass >/dev/null; then
    echo -e "${INFO} Installing dependencies..."
    apt-get update -y && apt-get install -y autossh sshpass
  fi
}

# --- Setup Server Side ---
setup_server() {
  echo -e "${INFO} Setting up Strelix Cloud tunnel server on $(hostname -I | awk '{print $1}')..."
  USER="tunnel1"
  PASS="naksh"
  SSHD_CONFIG="/etc/ssh/sshd_config"

  id "$USER" &>/dev/null || adduser --disabled-password --gecos "" "$USER"
  echo "$USER:$PASS" | chpasswd

  grep -q "AllowTcpForwarding yes" "$SSHD_CONFIG" || echo "AllowTcpForwarding yes" >> "$SSHD_CONFIG"
  grep -q "GatewayPorts yes" "$SSHD_CONFIG" || echo "GatewayPorts yes" >> "$SSHD_CONFIG"
  grep -q "PermitTunnel yes" "$SSHD_CONFIG" || echo "PermitTunnel yes" >> "$SSHD_CONFIG"

  systemctl restart ssh
  echo -e "${OK} Server ready for Strelix Cloud tunnels."
  echo -e "${C_WHITE}User:${C_RESET} ${C_YELLOW}$USER${C_RESET} | ${C_WHITE}Pass:${C_RESET} ${C_YELLOW}$PASS${C_RESET}"
}

# --- Create Tunnel ---
make_tunnel() {
  ensure_tools
  LOCAL_PORT=$1
  if [[ -z "$LOCAL_PORT" || ! "$LOCAL_PORT" =~ ^[0-9]+$ ]]; then
    echo -e "${ERR} Invalid local port!"
    exit 1
  fi
  REMOTE_PORT=$((RANDOM % 55535 + 10000))
  echo -e "${INFO} Creating tunnel: localhost:${LOCAL_PORT} ‚Üí ${REMOTE_HOST}:${REMOTE_PORT}"

  LOG="/tmp/strelix_tunnel_${REMOTE_PORT}.log"
  sshpass -p "$REMOTE_PASS" autossh -M 0 -N \
    -R ${REMOTE_PORT}:localhost:${LOCAL_PORT} \
    -o StrictHostKeyChecking=no \
    -o ServerAliveInterval=60 \
    -o ServerAliveCountMax=3 \
    ${REMOTE_USER}@${REMOTE_HOST} -p ${SSH_PORT} \
    &> "$LOG" &

  PID=$!
  sleep 2
  if ps -p $PID > /dev/null; then
    echo -e "${OK} Tunnel active!"
    echo -e "${C_WHITE}PID:${C_RESET} ${PID}"
    echo -e "${C_WHITE}Remote Port:${C_RESET} ${REMOTE_PORT}"
    echo -e "${C_WHITE}Access URL:${C_RESET} http://${REMOTE_HOST}:${REMOTE_PORT}"
  else
    echo -e "${ERR} Tunnel failed. Check log: ${LOG}"
  fi
}

# --- List Tunnels ---
list_tunnels() {
  PIDS=$(pgrep -af "autossh.*${REMOTE_HOST}")
  if [ -z "$PIDS" ]; then
    echo -e "${C_GREEN}No active Strelix Cloud tunnels.${C_RESET}"
  else
    echo -e "${C_WHITE}PID\t\tLocal ‚Üí Remote${C_RESET}"
    echo "$PIDS" | while read -r line; do
      pid=$(echo "$line" | awk '{print $1}')
      localp=$(echo "$line" | sed -n 's/.*localhost:\([0-9]*\).*/\1/p')
      remotep=$(echo "$line" | sed -n 's/.*-R \([0-9]*\):.*/\1/p')
      echo -e "${C_YELLOW}${pid}${C_RESET}\t\t${C_CYAN}${localp}${C_RESET} ‚Üí ${C_GREEN}${REMOTE_HOST}:${remotep}${C_RESET}"
    done
  fi
}

# --- Kill Tunnel by PID ---
kill_tunnel() {
  PID=$1
  if [ -z "$PID" ]; then
    echo -e "${ERR} Provide a PID."
    exit 1
  fi
  if ps -p $PID > /dev/null; then
    kill $PID && echo -e "${OK} Tunnel ${PID} stopped."
  else
    echo -e "${ERR} No such PID."
  fi
}

# --- Kill All Tunnels ---
kill_all() {
  PIDS=$(pgrep -f "autossh.*${REMOTE_HOST}")
  if [ -z "$PIDS" ]; then
    echo -e "${C_GREEN}No active tunnels.${C_RESET}"
  else
    echo -e "${STOP} Stopping all Strelix Cloud tunnels..."
    kill $PIDS && echo -e "${OK} All tunnels stopped."
  fi
}

# --- Command Handler ---
case "$1" in
  make) make_tunnel "$2" ;;
  list) list_tunnels ;;
  kill) kill_tunnel "$2" ;;
  killall) kill_all ;;
  setup-server) setup_server ;;
  *) usage ;;
esac
